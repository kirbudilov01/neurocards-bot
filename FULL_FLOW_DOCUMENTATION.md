# üîç –ü–û–õ–ù–ê–Ø –õ–û–ì–ò–ö–ê –†–ê–ë–û–¢–´ –ë–û–¢–ê - Neurocards

**–î–∞—Ç–∞:** 2026-01-22  
**–°—Ç–∞—Ç—É—Å:** üìã –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

---

## üì± **–§–õ–û–£ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–®–ê–ì –ó–ê –®–ê–ì–û–ú)**

### **1. –°—Ç–∞—Ä—Ç** `/start`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
- –ë–æ—Ç —Å–æ–∑–¥–∞—ë—Ç –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏—Ç –∑–∞–ø–∏—Å—å –≤ `users` —Ç–∞–±–ª–∏—Ü–µ
- –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å: **2 –∫—Ä–µ–¥–∏—Ç–∞**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π

### **2. –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é**
–ö–Ω–æ–ø–∫–∏:
- üé¨ **–°–¥–µ–ª–∞—Ç—å Reels** ‚Üí –ù–∞—á–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
- üë§ **–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç** ‚Üí –ü–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å + –∫–Ω–æ–ø–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
- üÜò **–ü–æ–¥–¥–µ—Ä–∂–∫–∞** ‚Üí –ö–æ–Ω—Ç–∞–∫—Ç —Å –∞–¥–º–∏–Ω–æ–º

---

## üé¨ **–ì–ï–ù–ï–†–ê–¶–ò–Ø –í–ò–î–ï–û (–ü–û–î–†–û–ë–ù–´–ô –§–õ–û–£)**

### **–®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ**
```
–ë–æ—Ç: "–ü—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ (–±–µ–∑ –ª—é–¥–µ–π –≤ –∫–∞–¥—Ä–µ)"
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `photo_file_id` –≤ FSM state
- –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É

---

### **–®–∞–≥ 2: –û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞**
```
–ë–æ—Ç: "–ù–∞–ø–∏—à–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º"
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–û—Ä—Ç–æ–ø–µ–¥–∏—á–µ—Å–∫–∞—è –ø–æ–¥—É—à–∫–∞ –¥–ª—è —Å–Ω–∞, —Å–Ω–∏–º–∞–µ—Ç –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ"
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `product_text` –≤ state
- –ü–µ—Ä–µ—Ö–æ–¥ –∫ –≤—ã–±–æ—Ä—É —à–∞–±–ª–æ–Ω–∞

---

### **–®–∞–≥ 3: –í—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞**
```
–ë–æ—Ç: "üéõ –í—ã–±–µ—Ä–∏ —à–∞–±–ª–æ–Ω:"
–ö–Ω–æ–ø–∫–∏:
  üé• UGC –ë–ª–æ–≥–µ—Ä
  üì¢ –†–µ–∫–ª–∞–º–∞
  üßë‚Äçüíª –°–≤–æ–π –ø—Ä–æ–º–ø—Ç
```

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**

#### **A) UGC –ë–ª–æ–≥–µ—Ä / –†–µ–∫–ª–∞–º–∞**
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –∫ –®–∞–≥—É 4

#### **B) –°–≤–æ–π –ø—Ä–æ–º–ø—Ç**
```
–ë–æ—Ç: "–í—Å—Ç–∞–≤—å —Å–≤–æ–π prompt –¥–ª—è Sora/KIE –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º"
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "A close-up of a pillow floating in air..."
```
- –ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `user_prompt`
- **–ü–†–û–ü–£–°–ö–ê–ï–¢ –®–∞–≥ 4** (–¥–æ–ø. –ø–æ–∂–µ–ª–∞–Ω–∏—è –Ω–µ –Ω—É–∂–Ω—ã)
- –°—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥ –∫ –®–∞–≥—É 5 (–≤—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞)

---

### **–®–∞–≥ 4: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è** (—Ç–æ–ª—å–∫–æ –¥–ª—è UGC/–†–µ–∫–ª–∞–º–∞)
```
–ë–æ—Ç: "‚ú® –ï—Å—Ç—å –ª–∏ –¥–æ–ø. –ø–æ–∂–µ–ª–∞–Ω–∏—è? –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ—Ç–ø—Ä–∞–≤—å ¬´-¬ª"
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–î–æ–±–∞–≤—å –¥–∏–Ω–∞–º–∏—á–Ω—É—é –º—É–∑—ã–∫—É" –ò–õ–ò "-"
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ï—Å–ª–∏ –Ω–∞–ø–∏—Å–∞–ª `-` –∏–ª–∏ `–Ω–µ—Ç` ‚Üí `extra_wishes = None`
- –ò–Ω–∞—á–µ ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ–∂–µ–ª–∞–Ω–∏–π
- –ü–µ—Ä–µ—Ö–æ–¥ –∫ –®–∞–≥—É 5

---

### **–®–∞–≥ 5: –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ** ‚úÖ –ù–û–í–û–ï!
```
–ë–æ—Ç: "üé¨ –°–∫–æ–ª—å–∫–æ –≤–∏–¥–µ–æ —Ö–æ—á–µ—à—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å?"
–ö–Ω–æ–ø–∫–∏:
  1Ô∏è‚É£ 1 –≤–∏–¥–µ–æ (1 –∫—Ä–µ–¥–∏—Ç)
  3Ô∏è‚É£ 3 –≤–∏–¥–µ–æ (3 –∫—Ä–µ–¥–∏—Ç–∞)
  5Ô∏è‚É£ 5 –≤–∏–¥–µ–æ (5 –∫—Ä–µ–¥–∏—Ç–æ–≤)
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (1, 3 –∏–ª–∏ 5)
- –ë–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å:
  - ‚úÖ **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤** ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
  - ‚ùå **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ** ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ + –∫–Ω–æ–ø–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç `video_count` –≤ state

---

### **–®–∞–≥ 6: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ**
```
–ë–æ—Ç: 
"üé¨ –ì–æ—Ç–æ–≤—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é?

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ: 3
–°—Ç–æ–∏–º–æ—Å—Ç—å: 3 –∫—Ä–µ–¥–∏—Ç–∞
–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: 5

‚è± –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–π–º—ë—Ç –æ—Ç 1 –¥–æ 30 –º–∏–Ω—É—Ç

–ó–∞–ø—É—Å–∫–∞–µ–º?"

–ö–Ω–æ–ø–∫–∏:
  ‚úÖ –î–∞, –∑–∞–ø—É—Å—Ç–∏—Ç—å
  ‚ùå –û—Ç–º–µ–Ω–∞
```

**–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–î–∞, –∑–∞–ø—É—Å—Ç–∏—Ç—å":**

---

## üîÑ **–ß–¢–û –ü–†–û–ò–°–•–û–î–ò–¢ –ü–†–ò –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ò**

### **1. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ**
```
–ë–æ—Ç: "‚úÖ –ü—Ä–∏–Ω—è–ª!

üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 3 –≤–∏–¥–µ–æ –∑–∞–ø—É—â–µ–Ω–∞!

‚è± –û–∂–∏–¥–∞–π—Ç–µ ‚Äî —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –æ—Ç 1 –¥–æ 30 –º–∏–Ω—É—Ç

–Ø –ø—Ä–∏—à–ª—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—é–¥–∞ –ø–æ –º–µ—Ä–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏."
```

### **2. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –≤ –ë–î** (–¶–ò–ö–õ)

–î–ª—è –ö–ê–ñ–î–û–ì–û –≤–∏–¥–µ–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ 3):

```python
for i in range(video_count):  # i = 0, 1, 2
    # –°–æ–∑–¥–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π idempotency_key
    idempotency_key = f"{callback_id}_{i}"
    
    # –í—ã–∑–≤–∞—Ç—å start_generation()
    job_id = await start_generation(...)
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç `start_generation()` –¥–ª—è –ö–ê–ñ–î–û–ì–û –≤–∏–¥–µ–æ:**

#### **2.1. –°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ** (1 —Ä–∞–∑, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö)
```python
photo_bytes = await download_photo_bytes(bot, photo_file_id)
```

#### **2.2. –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ storage** (–î–õ–Ø –ö–ê–ñ–î–û–ì–û job'–∞ –æ—Ç–¥–µ–ª—å–Ω–æ!)
```python
input_path = f"{tg_user_id}/{uuid4().hex}.jpg"
storage.upload_input(input_path, photo_bytes)
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í storage —Å–æ–∑–¥–∞—ë—Ç—Å—è 3 –∫–æ–ø–∏–∏ —Ñ–æ—Ç–æ (–ø–æ –æ–¥–Ω–æ–π –Ω–∞ –∫–∞–∂–¥—ã–π job)

#### **2.3. –°–æ–∑–¥–∞—Ç—å job –í –ë–î + —Å–ø–∏—Å–∞—Ç—å –∫—Ä–µ–¥–∏—Ç**
```python
job_id = await create_job_and_consume_credit(
    tg_user_id=123456,
    idempotency_key="callback_123_0",  # —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
    kind="reels",
    input_photo_path="123456/abc123.jpg",
    product_info={"text": "...", "user_prompt": "..."},
    extra_wishes="...",
    template_id="ugc",
)
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –ë–î:**
```sql
BEGIN TRANSACTION;

-- 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å idempotency_key (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π)
SELECT id FROM jobs WHERE idempotency_key = 'callback_123_0';

-- 2. –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT id, credits FROM users WHERE tg_user_id = 123456 FOR UPDATE;

-- 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å
IF credits < 1 THEN RAISE EXCEPTION;

-- 4. –°–ø–∏—Å–∞—Ç—å 1 –∫—Ä–µ–¥–∏—Ç
UPDATE users SET credits = credits - 1 WHERE tg_user_id = 123456;

-- 5. –°–æ–∑–¥–∞—Ç—å job
INSERT INTO jobs (
    user_id, tg_user_id, idempotency_key, kind, template_id,
    input_photo_path, product_info, extra_wishes, status
) VALUES (..., 'queued');

COMMIT;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ —Ü–∏–∫–ª–∞:**
- –í –ë–î —Å–æ–∑–¥–∞–Ω–æ **3 job'–∞** —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `queued`
- –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–ø–∏—Å–∞–Ω–æ **3 –∫—Ä–µ–¥–∏—Ç–∞** (–ø–æ 1 –∑–∞ –∫–∞–∂–¥—ã–π job)
- –í storage –∑–∞–≥—Ä—É–∂–µ–Ω–æ **3 –∫–æ–ø–∏–∏** —Ñ–æ—Ç–æ
- –ö–∞–∂–¥—ã–π job –∏–º–µ–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `idempotency_key`

---

## ‚öôÔ∏è **–ß–¢–û –î–ï–õ–ê–Æ–¢ WORKER'–´**

### **Polling —Ü–∏–∫–ª** (20 worker'–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)

```python
while True:
    # 1. –í–∑—è—Ç—å —Å–ª–µ–¥—É—é—â–∏–π job –∏–∑ –æ—á–µ—Ä–µ–¥–∏
    job = await fetch_next_queued_job()  # FOR UPDATE SKIP LOCKED
    
    if not job:
        await asyncio.sleep(2)
        continue
    
    # 2. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ 'processing'
    await update_job(job_id, {
        "status": "processing",
        "started_at": NOW(),
        "attempts": attempts + 1
    })
    
    # 3. –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await bot.send_message(tg_user_id, "üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞...")
    
    # 4. –≠–¢–ê–ü GPT (–µ—Å–ª–∏ –Ω–µ self-–ø—Ä–æ–º–ø—Ç)
    if template_id != "self":
        script = build_prompt_with_gpt(
            system=TEMPLATES[template_id]["system"],
            instructions=TEMPLATES[template_id]["instructions"],
            product_text=product_text,
            extra_wishes=extra_wishes
        )
    else:
        script = user_prompt  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–º–ø—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–ø—Ä—è–º—É—é
    
    # 5. –ü–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á –∏–∑ —Ä–æ—Ç–∞—Ç–æ—Ä–∞
    api_key = get_rotator().get_key()
    
    # 6. –≠–¢–ê–ü KIE - –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
    task_id = create_task_sora_i2v(
        prompt=script,
        image_url=get_public_url(input_photo_path),
        api_key=api_key
    )
    
    await update_job(job_id, {"kie_task_id": task_id})
    
    # 7. –≠–¢–ê–ü KIE - Polling (5-30 –º–∏–Ω—É—Ç)
    info = poll_record_info(task_id, api_key, timeout=360, interval=10)
    
    # 8. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (—Å–º. –Ω–∏–∂–µ)
```

---

## üéØ **–û–ë–†–ê–ë–û–¢–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –û–¢ KIE**

### **–°—Ü–µ–Ω–∞—Ä–∏–π A: –£–°–ü–ï–•** ‚úÖ

```python
video_url = find_video_url(info)
if video_url:
    # –û—Ç–º–µ—Ç–∏—Ç—å —É—Å–ø–µ—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞
    get_rotator().report_success(api_key)
    
    # –°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ
    video_bytes = await download_bytes(video_url)
    
    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await bot.send_video(
        tg_user_id,
        video=video_bytes,
        caption="‚úÖ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ!",
        reply_markup=kb_result()  # –ö–Ω–æ–ø–∫–∏: "–ï—â—ë —Ä–∞–∑" / "–ú–µ–Ω—é"
    )
    
    # –û–±–Ω–æ–≤–∏—Ç—å job
    await update_job(job_id, {
        "status": "done",
        "finished_at": NOW(),
        "output_url": video_url
    })
```

**–ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
- –ü–æ–ª—É—á–∞–µ—Ç –≤–∏–¥–µ–æ –≤ Telegram (–µ—Å–ª–∏ <45MB)
- –ò–õ–ò —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ >45MB)
- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞ –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é

---

### **–°—Ü–µ–Ω–∞—Ä–∏–π B: –û–®–ò–ë–ö–ê** ‚ùå

#### **1. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–∫–∏**
```python
error_type, error_msg = classify_kie_error(info)
```

**–¢–∏–ø—ã –æ—à–∏–±–æ–∫:**

| –¢–∏–ø | –ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å | –î–µ–π—Å—Ç–≤–∏–µ |
|-----|---------------|----------|
| **USER_VIOLATION** | –§–æ—Ç–æ/–ø—Ä–æ–º–ø—Ç –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ Sora | ‚ùå –ù–µ retry, –≤–µ—Ä–Ω—É—Ç—å –∫—Ä–µ–¥–∏—Ç |
| **BILLING** | –ü—Ä–æ–±–ª–µ–º–∞ —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º KIE | ‚ùå –ù–µ retry, –≤–µ—Ä–Ω—É—Ç—å –∫—Ä–µ–¥–∏—Ç, –∞–ª–µ—Ä—Ç –∞–¥–º–∏–Ω—É |
| **RATE_LIMIT** | –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (429) | üîÑ Retry –¥–æ 3 —Ä–∞–∑ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π |
| **TEMPORARY** | –í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ (503, timeout) | üîÑ Retry –¥–æ 3 —Ä–∞–∑ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π |
| **UNKNOWN** | –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ | ‚ùå –ù–µ retry, –≤–µ—Ä–Ω—É—Ç—å –∫—Ä–µ–¥–∏—Ç |

#### **2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ —Ç–∏–ø—É**

##### **USER_VIOLATION** (–Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª)
```python
# –í–µ—Ä–Ω—É—Ç—å –∫—Ä–µ–¥–∏—Ç
await refund_credit(tg_user_id, 1)

# –û–±–Ω–æ–≤–∏—Ç—å job
await update_job(job_id, {
    "status": "failed",
    "error": error_msg,
    "finished_at": NOW()
})

# –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await bot.send_message(tg_user_id,
    "‚ö†Ô∏è –í—ã –Ω–∞—Ä—É—à–∏–ª–∏ –ø—Ä–∞–≤–∏–ª–∞ SORA 2\n\n"
    "–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏—Ç–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫:\n"
    "‚Ä¢ —Ñ–æ—Ç–æ (—á–∞—â–µ –≤—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Ñ–æ—Ç–æ)\n"
    "‚Ä¢ –ø—Ä–æ–º–ø—Ç—É\n\n"
    "1 –∫—Ä–µ–¥–∏—Ç –≤–µ—Ä–Ω—É–ª–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å ‚úÖ"
)
```

##### **BILLING** (–ø—Ä–æ–±–ª–µ–º–∞ —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º)
```python
# –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á –Ω–∞ 24 —á–∞—Å–∞
get_rotator().report_billing_error(api_key)

# –í–µ—Ä–Ω—É—Ç—å –∫—Ä–µ–¥–∏—Ç
await refund_credit(tg_user_id, 1)

# –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await bot.send_message(tg_user_id,
    "‚ö†Ô∏è –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ–ø–æ–ª–∞–¥–∫–∏\n\n"
    "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏: @kirbudilov\n\n"
    "1 –∫—Ä–µ–¥–∏—Ç –≤–µ—Ä–Ω—É–ª–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å ‚úÖ"
)

# TODO: –ê–ª–µ—Ä—Ç –∞–¥–º–∏–Ω—É (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
# await alert_admin("KIE billing issue!")
```

##### **RATE_LIMIT** (–ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç)
```python
# –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á –Ω–∞ 60 –º–∏–Ω—É—Ç
get_rotator().report_rate_limit(api_key, cooldown_minutes=60)

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å attempts
if job["attempts"] < 3:
    # RETRY!
    delay = get_retry_delay(error_type, attempts)  # 60s ‚Üí 120s ‚Üí 240s
    
    # –í–µ—Ä–Ω—É—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å
    await update_job(job_id, {"status": "queued"})
    
    # –ü–æ–¥–æ–∂–¥–∞—Ç—å
    await asyncio.sleep(delay)
    
    # Worker –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç —Å–Ω–æ–≤–∞ (—Å attempts + 1)
else:
    # –§–∏–Ω–∞–ª—å–Ω—ã–π fail –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫
    await refund_credit(tg_user_id, 1)
    await update_job(job_id, {
        "status": "failed",
        "error": error_msg,
        "finished_at": NOW()
    })
    
    await bot.send_message(tg_user_id,
        "‚è≥ –°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω\n\n"
        "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.\n\n"
        "1 –∫—Ä–µ–¥–∏—Ç –≤–µ—Ä–Ω—É–ª–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å ‚úÖ"
    )
```

##### **TEMPORARY** (–≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞)
```python
# –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–ª—é—á (—ç—Ç–æ –Ω–µ –µ–≥–æ –ø—Ä–æ–±–ª–µ–º–∞)
get_rotator().report_success(api_key)

# Retry –¥–æ 3 —Ä–∞–∑
if job["attempts"] < 3:
    delay = get_retry_delay(error_type, attempts)  # 10s ‚Üí 20s ‚Üí 40s
    
    # –£–≤–µ–¥–æ–º–∏—Ç—å –æ retry (—Ç–æ–ª—å–∫–æ –¥–ª—è TEMPORARY)
    await bot.send_message(tg_user_id,
        "‚ö†Ô∏è –í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏\n\n"
        "–ú—ã –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.\n"
        "–ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è - –≤–µ—Ä–Ω—ë–º –∫—Ä–µ–¥–∏—Ç."
    )
    
    await update_job(job_id, {"status": "queued"})
    await asyncio.sleep(delay)
else:
    # –§–∏–Ω–∞–ª—å–Ω—ã–π fail
    await refund_credit(tg_user_id, 1)
    await bot.send_message(tg_user_id,
        "‚ùå –ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å\n\n"
        "1 –∫—Ä–µ–¥–∏—Ç –≤–µ—Ä–Ω—É–ª–∏ ‚úÖ"
    )
```

---

## üîÑ **RETRY –õ–û–ì–ò–ö–ê (–î–ï–¢–ê–õ–¨–ù–û)**

### **–ö–æ–≥–¥–∞ –¥–µ–ª–∞–µ—Ç—Å—è retry:**
‚úÖ **RATE_LIMIT** (429 –æ—Ç KIE)  
‚úÖ **TEMPORARY** (503, timeout, —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏)  

### **–ö–æ–≥–¥–∞ –ù–ï –¥–µ–ª–∞–µ—Ç—Å—è retry:**
‚ùå **USER_VIOLATION** (–ø—Ä–æ–±–ª–µ–º–∞ —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º)  
‚ùå **BILLING** (–ø—Ä–æ–±–ª–µ–º–∞ —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º)  
‚ùå **UNKNOWN** (–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞)  

### **–ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫:** 3

### **Exponential backoff:**

| –ü–æ–ø—ã—Ç–∫–∞ | RATE_LIMIT | TEMPORARY |
|---------|-----------|-----------|
| 1 ‚Üí 2 | 60 —Å–µ–∫ | 10 —Å–µ–∫ |
| 2 ‚Üí 3 | 120 —Å–µ–∫ | 20 —Å–µ–∫ |
| 3 ‚Üí fail | 240 —Å–µ–∫ | 40 —Å–µ–∫ |

### **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ retry:**
1. Job –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ `status = 'queued'`
2. `attempts` –ù–ï —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è (—É–≤–µ–ª–∏—á–∏—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤–∑—è—Ç–∏–∏)
3. Worker –¥–µ–ª–∞–µ—Ç `await asyncio.sleep(delay)`
4. –î—Ä—É–≥–æ–π worker (–∏–ª–∏ —ç—Ç–æ—Ç –∂–µ) –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç job —Å–Ω–æ–≤–∞
5. –ü—Ä–∏ –≤–∑—è—Ç–∏–∏ job: `attempts = attempts + 1`
6. –ï—Å–ª–∏ `attempts >= 3` –∏ —Å–Ω–æ–≤–∞ –æ—à–∏–±–∫–∞ ‚Üí —Ñ–∏–Ω–∞–ª—å–Ω—ã–π fail

---

## üí∞ **–í–û–ó–í–†–ê–¢ –ö–†–ï–î–ò–¢–û–í**

### **–ö–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫—Ä–µ–¥–∏—Ç:**
‚úÖ USER_VIOLATION (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)  
‚úÖ BILLING (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)  
‚úÖ RATE_LIMIT –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫  
‚úÖ TEMPORARY –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫  
‚úÖ UNKNOWN (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)  
‚úÖ –õ—é–±–∞—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ worker  

### **–ö–æ–≥–¥–∞ –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è:**
‚ùå –í–æ –≤—Ä–µ–º—è retry –ø–æ–ø—ã—Ç–æ–∫  
‚ùå –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏  

### **–ú–µ—Ö–∞–Ω–∏–∑–º –≤–æ–∑–≤—Ä–∞—Ç–∞:**
```sql
-- –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤ PostgreSQL
UPDATE users 
SET credits = credits + 1, updated_at = NOW()
WHERE tg_user_id = 123456;
```

---

## üîë **–†–û–¢–ê–¶–ò–Ø API –ö–õ–Æ–ß–ï–ô**

### **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```python
# 1. –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ worker –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –∫–ª—é—á–∏
keys = [
    os.getenv("KIE_API_KEY"),      # –û—Å–Ω–æ–≤–Ω–æ–π
    os.getenv("KIE_API_KEY_1"),    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ
    os.getenv("KIE_API_KEY_2"),
    # ...
]

# 2. Round-robin –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞
rotator = KieKeyRotator()
api_key = rotator.get_key()  # –í—ã–¥–∞—ë—Ç —Å–ª–µ–¥—É—é—â–∏–π –∑–¥–æ—Ä–æ–≤—ã–π –∫–ª—é—á

# 3. Health tracking
rotator.report_success(key)           # –ö–ª—é—á —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ
rotator.report_rate_limit(key)        # –ë–ª–æ–∫–∏—Ä—É–µ–º –Ω–∞ 60 –º–∏–Ω—É—Ç
rotator.report_billing_error(key)     # –ë–ª–æ–∫–∏—Ä—É–µ–º –Ω–∞ 24 —á–∞—Å–∞
```

### **–°–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª—é—á–∞:**
- **Healthy** (–∞–∫—Ç–∏–≤–µ–Ω) - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–æ—Ç–∞—Ü–∏–∏
- **Blocked** (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω) - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ —Ä–æ—Ç–∞—Ü–∏–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏

### **–ï—Å–ª–∏ –≤—Å–µ –∫–ª—é—á–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã:**
- –†–æ—Ç–∞—Ç–æ—Ä –≤—ã–¥–∞—ë—Ç –ø–µ—Ä–≤—ã–π –∫–ª—é—á (–ø—É—Å—Ç—å –ø–æ–ø—Ä–æ–±—É–µ—Ç)
- –í –ª–æ–≥–∞—Ö: `‚ö†Ô∏è All KIE API keys are blocked`
- Worker –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É, –Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –ø–∞–¥–∞—Ç—å —Å –æ—à–∏–±–∫–∞–º–∏

---

## üìä **–ü–†–ò–ú–ï–† –ü–û–õ–ù–û–ì–û –°–¶–ï–ù–ê–†–ò–Ø**

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª **3 –≤–∏–¥–µ–æ**:

### **T+0s: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ**
- ‚úÖ –°–æ–∑–¥–∞–Ω–æ 3 job'–∞: `job_1`, `job_2`, `job_3`
- ‚úÖ –°–ø–∏—Å–∞–Ω–æ 3 –∫—Ä–µ–¥–∏—Ç–∞ (–±—ã–ª–æ 5, –æ—Å—Ç–∞–ª–æ—Å—å 2)
- üì® –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è 3 –≤–∏–¥–µ–æ –∑–∞–ø—É—â–µ–Ω–∞!"

### **T+1s: Worker –±–µ—Ä—ë—Ç job_1**
- üîÑ `job_1`: `queued` ‚Üí `processing`
- üì® "üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞..."
- ü§ñ GPT –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç (30 —Å–µ–∫)
- üîë –ü–æ–ª—É—á–µ–Ω `api_key_1`
- üé• –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ KIE API

### **T+2s: Worker –±–µ—Ä—ë—Ç job_2**
- üîÑ `job_2`: `queued` ‚Üí `processing`
- üì® "üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞..."
- ü§ñ GPT –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç
- üîë –ü–æ–ª—É—á–µ–Ω `api_key_2` (—Å–ª–µ–¥—É—é—â–∏–π –≤ —Ä–æ—Ç–∞—Ü–∏–∏)
- üé• –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ KIE API

### **T+3s: Worker –±–µ—Ä—ë—Ç job_3**
- üîÑ `job_3`: `queued` ‚Üí `processing`
- ü§ñ GPT –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç
- üîë –ü–æ–ª—É—á–µ–Ω `api_key_1` (—Å–Ω–æ–≤–∞ –ø–µ—Ä–≤—ã–π)
- üé• –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ KIE API

### **T+5-30 –º–∏–Ω—É—Ç: Polling**
- ‚è≥ –í—Å–µ 3 worker'–∞ –æ–ø—Ä–∞—à–∏–≤–∞—é—Ç KIE –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥

### **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**

#### **job_1: –£—Å–ø–µ—Ö** ‚úÖ
- T+6min: –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ
- üì® –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –≤–∏–¥–µ–æ #1
- ‚úÖ `job_1` ‚Üí `done`

#### **job_2: Rate limit** ‚ö†Ô∏è
- T+7min: –û—à–∏–±–∫–∞ 429
- üîê `api_key_2` –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ 60 –º–∏–Ω—É—Ç
- üîÑ `job_2` ‚Üí `queued` (retry #1)
- ‚è≥ –ß–µ—Ä–µ–∑ 60 —Å–µ–∫ worker –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Å–Ω–æ–≤–∞
- T+8min: Retry —É—Å–ø–µ—à–µ–Ω
- üì® –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –≤–∏–¥–µ–æ #2
- ‚úÖ `job_2` ‚Üí `done`

#### **job_3: User violation** ‚ùå
- T+10min: –û—à–∏–±–∫–∞ "inappropriate content"
- ‚ùå `job_3` ‚Üí `failed`
- üí∞ –í–æ–∑–≤—Ä–∞—Ç 1 –∫—Ä–µ–¥–∏—Ç–∞ (–±—ã–ª–æ 2, —Å—Ç–∞–ª–æ 3)
- üì® "‚ö†Ô∏è –í—ã –Ω–∞—Ä—É—à–∏–ª–∏ –ø—Ä–∞–≤–∏–ª–∞ SORA 2..."

### **–ò—Ç–æ–≥–æ:**
- ‚úÖ 2 –≤–∏–¥–µ–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ
- ‚ùå 1 –≤–∏–¥–µ–æ –Ω–µ –ø—Ä–æ—à–ª–æ –º–æ–¥–µ—Ä–∞—Ü–∏—é
- üí∞ –°–ø–∏—Å–∞–Ω–æ 2 –∫—Ä–µ–¥–∏—Ç–∞ (3 - 1 –≤–æ–∑–≤—Ä–∞—Ç)
- ‚è± –í—Ä–µ–º—è: ~10 –º–∏–Ω—É—Ç

---

## ‚ùì **–ù–ï–†–ï–®–Å–ù–ù–´–ï –í–û–ü–†–û–°–´**

### **1. Webhook –±–æ—Ç–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** ‚ö†Ô∏è
- **–ü—Ä–æ–±–ª–µ–º–∞:** Telegram —Ç—Ä–µ–±—É–µ—Ç HTTPS, —É –Ω–∞—Å HTTP
- **–†–µ—à–µ–Ω–∏–µ:** Nginx + Let's Encrypt –ò–õ–ò Cloudflare Tunnel
- **–ë–ª–æ–∫–∏—Ä—É–µ—Ç:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram
- **–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç:** Worker'—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ

### **2. –ö–æ–¥ –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω** ‚ö†Ô∏è
- –ù–∞–ø–∏—Å–∞–Ω –∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç
- Worker'—ã –∑–∞–ø—É—â–µ–Ω—ã
- –ù–û: –Ω–µ –±—ã–ª–æ live —Ç–µ—Å—Ç–∞ —Å —Ä–µ–∞–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π

### **3. –ù–µ—Ç –∞–ª–µ—Ä—Ç–æ–≤ –∞–¥–º–∏–Ω—É**
- –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö billing - –∞–¥–º–∏–Ω –Ω–µ —É–≤–µ–¥–æ–º–ª—è–µ—Ç—Å—è
- –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å: `await bot.send_message(ADMIN_ID, "Alert!")`

---

## ‚úÖ **–ß–¢–û –†–ê–ë–û–¢–ê–ï–¢ –¢–û–ß–ù–û**

1. ‚úÖ 20 worker'–æ–≤ –∑–∞–ø—É—â–µ–Ω—ã
2. ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
3. ‚úÖ –†–æ—Ç–∞—Ç–æ—Ä –∫–ª—é—á–µ–π –Ω–∞–ø–∏—Å–∞–Ω
4. ‚úÖ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
5. ‚úÖ Retry –ª–æ–≥–∏–∫–∞ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞
6. ‚úÖ –í–æ–∑–≤—Ä–∞—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
7. ‚úÖ –í—ã–±–æ—Ä 1/3/5 –≤–∏–¥–µ–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
8. ‚úÖ –ö–∞–∂–¥–æ–µ –≤–∏–¥–µ–æ = –æ—Ç–¥–µ–ª—å–Ω—ã–π job

---

## üöÄ **–ß–¢–û –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨**

### **–ö–†–ò–¢–ò–ß–ù–û:**
1. **Fix HTTPS webhook** (15 –º–∏–Ω)
   - Nginx + certbot –ò–õ–ò Cloudflare Tunnel
   
2. **End-to-end —Ç–µ—Å—Ç** (30 –º–∏–Ω)
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞/retry)
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ 3 –≤–∏–¥–µ–æ –ø—Ä–∏—Ö–æ–¥—è—Ç

### **–í–ê–ñ–ù–û:**
3. **–ê–ª–µ—Ä—Ç—ã –∞–¥–º–∏–Ω—É** (10 –º–∏–Ω)
   ```python
   ADMIN_TG_ID = 5235703016
   await bot.send_message(ADMIN_TG_ID, f"üö® KIE billing error: {error}")
   ```

4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ª—É—á—à–∏—Ç—å** (5 –º–∏–Ω)
   - –°–µ–π—á–∞—Å –ª–æ–≥–∏ –≤ syslog
   - –î–æ–±–∞–≤–∏—Ç—å structured logging

5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - Dashboard –¥–ª—è `/queue_stats`
   - Grafana + Prometheus

---

**–ò—Ç–æ–≥:** –°–∏—Å—Ç–µ–º–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ –≥–æ—Ç–æ–≤–∞, –∫–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω –∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç, –Ω–æ –Ω—É–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ç—å webhook –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram.
