version: '3.8'

services:
  # –¢–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç (–≤–µ–±-—Å–µ—Ä–≤–∏—Å, webhook)
  bot:
    build: .
    container_name: neurocards-bot
    command: python -m app.main
    environment:
      - BOT_TOKEN=${BOT_TOKEN}
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL}
      - DATABASE_URL=${DATABASE_URL}
      - WEBHOOK_SECRET_TOKEN=${WEBHOOK_SECRET_TOKEN:-random_secret_token}
    ports:
      - "10000:10000"
    network_mode: host
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:10000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Background Worker (–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–π)
  worker:
    build: .
    command: python -m worker.worker
    environment:
      - BOT_TOKEN=${BOT_TOKEN}
      - KIE_API_KEY=${KIE_API_KEY}
      - KIE_BASE_URL=${KIE_BASE_URL:-https://api.kie.ai}
      - KIE_CREATE_TASK_URL=${KIE_CREATE_TASK_URL:-https://api.kie.ai/api/v1/jobs/createTask}
      - KIE_RECORD_INFO_URL=${KIE_RECORD_INFO_URL:-https://api.kie.ai/api/v1/jobs/recordInfo}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com}
      - DATABASE_URL=${DATABASE_URL}
    network_mode: host
    restart: unless-stopped
    deploy:
      replicas: 5  # üî• 5 –≤–æ—Ä–∫–µ—Ä–æ–≤ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
