#!/bin/bash

# üîÑ –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞ –Ω–∞ VPS
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/update_vps.sh YOUR_SERVER_IP

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

if [ -z "$1" ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω IP —Å–µ—Ä–≤–µ—Ä–∞${NC}"
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 YOUR_SERVER_IP"
    exit 1
fi

SERVER_IP=$1
SERVER_USER="botuser"

echo -e "${GREEN}üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞ –Ω–∞ ${SERVER_IP}${NC}"
echo ""

# –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
echo -e "${YELLOW}üì• –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è...${NC}"
ssh ${SERVER_USER}@${SERVER_IP} << 'ENDSSH'
    cd ~/neurocards-bot
    git pull origin main
    
    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    source venv/bin/activate
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    pip install --upgrade pip
    pip install -r requirements.txt
ENDSSH

echo ""

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
echo -e "${YELLOW}üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã...${NC}"
ssh root@${SERVER_IP} << 'ENDSSH'
    systemctl restart neurocards-bot
    systemctl restart 'neurocards-worker@*'
    
    # –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã
    sleep 3
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    echo ""
    echo "üìä –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:"
    systemctl is-active --quiet neurocards-bot && echo "‚úÖ Bot: Running" || echo "‚ùå Bot: Failed"
    systemctl is-active --quiet 'neurocards-worker@*' && echo "‚úÖ Workers: Running" || echo "‚ùå Workers: Failed"
ENDSSH

echo ""
echo -e "${GREEN}‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!${NC}"
echo ""
echo -e "${YELLOW}üìù –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:${NC}"
echo "  ssh ${SERVER_USER}@${SERVER_IP} 'sudo journalctl -u neurocards-bot -n 50'"
echo "  ssh ${SERVER_USER}@${SERVER_IP} 'sudo journalctl -u neurocards-worker@1 -n 50'"
