# üß™ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–í–¢–û–ù–û–ú–ù–û–ì–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

**–î–∞—Ç–∞:** 2026-01-22  
**–í—Ä–µ–º—è:** 21:00 UTC (00:00 MSK)  
**–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 40 –º–∏–Ω—É—Ç –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–π —Ä–∞–±–æ—Ç—ã

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –û–®–ò–ë–ö–ò

### 1. **–°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ worker.py**
- **–ü—Ä–æ–±–ª–µ–º–∞:** `MAX_RETRY_ATTEMPTS` –≤–Ω—É—Ç—Ä–∏ import statement
- **–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–º–µ—â–µ–Ω –ø–æ—Å–ª–µ import'–æ–≤
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

### 2. **–õ–æ–≥–∏–∫–∞ retry loop –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–ª–æ–º–∞–Ω–∞**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –í–ª–æ–∂–µ–Ω–Ω—ã–π `for retry_attempt` –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, continue –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö, –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è continue
- **–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–ø–∏—Å–∞–Ω –≤–µ—Å—å main loop —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π:
  - Job –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ `queued` —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ retry
  - Worker'—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç job –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
  - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ retry
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

### 3. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é**
- **–ü—Ä–æ–±–ª–µ–º–∞:** 2 —Å–æ–æ–±—â–µ–Ω–∏—è "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞" (–∏–∑ generation.py –∏ worker.py)
- **–†–µ—à–µ–Ω–∏–µ:** –£–±—Ä–∞–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏–∑ generation.py, –æ—Å—Ç–∞–≤–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ –≤ worker.py
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

### 4. **–û—à–∏–±–∫–∞ `refund_credit() takes 1 positional argument but 2 were given`**
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–¥ –≤—ã–∑—ã–≤–∞–ª `refund_credit(tg_user_id, 1)` –≤–º–µ—Å—Ç–æ `refund_credit(tg_user_id)`
- **–†–µ—à–µ–Ω–∏–µ:** –§—É–Ω–∫—Ü–∏—è –≤ db_adapter.py —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 1 –∫—Ä–µ–¥–∏—Ç), –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –≤—ã–∑–æ–≤—ã
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üöÄ –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï –°–ò–°–¢–ï–ú–´

### –°–µ—Ä–≤–∏—Å—ã –Ω–∞ VPS (185.93.108.162)
```
‚úÖ neurocards-bot.service          - ACTIVE (running)
‚úÖ neurocards-worker@1.service     - ACTIVE (running)
‚úÖ neurocards-worker@2.service     - ACTIVE (running)
‚úÖ neurocards-worker@3.service     - ACTIVE (running)
‚úÖ neurocards-worker@4.service     - ACTIVE (running)
‚úÖ neurocards-worker@5.service     - ACTIVE (running)
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```
‚úÖ PostgreSQL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ Connection pool –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –≤—Å–µ—Ö worker'–æ–≤
‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 5235703016 –∏–º–µ–µ—Ç 155 –∫—Ä–µ–¥–∏—Ç–æ–≤
```

### –õ–æ–≥–∏
```
‚úÖ –í—Å–µ worker'—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã
‚úÖ Bot –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö
‚úÖ Worker'—ã –∂–¥—É—Ç jobs –≤ –æ—á–µ—Ä–µ–¥–∏
```

---

## üìã –ß–¢–û –ù–£–ñ–ù–û –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–¢–¨ –í–†–£–ß–ù–£–Æ

### Test Case 1: –ë–∞–∑–æ–≤—ã–π Flow
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/start` –≤ –±–æ—Ç–∞
2. –ù–∞–∂–∞—Ç—å "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å reels"
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞
4. –í–≤–µ—Å—Ç–∏ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
5. –í—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω (ugc/ad/self)
6. –ï—Å–ª–∏ self - –≤–≤–µ—Å—Ç–∏ —Å–≤–æ–π prompt
7. –ï—Å–ª–∏ ugc/ad - –≤–≤–µ—Å—Ç–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∏–ª–∏ "-"
8. **–ù–û–í–û–ï:** –í—ã–±—Ä–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ (1/3/5)
9. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- ‚úÖ –¢–û–õ–¨–ö–û –û–î–ù–û —Å–æ–æ–±—â–µ–Ω–∏–µ "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞"
- ‚úÖ Worker –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç job –∏–∑ –æ—á–µ—Ä–µ–¥–∏
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ KIE API
- ‚úÖ Polling —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–¥–æ 6 –º–∏–Ω—É—Ç)
- ‚úÖ –ü—Ä–∏ —É—Å–ø–µ—Ö–µ - –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤–∏–¥–µ–æ
- ‚úÖ –ü—Ä–∏ –æ—à–∏–±–∫–µ - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ retry (–¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫)

### Test Case 2: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–∏–¥–µ–æ
1. –í—ã–±—Ä–∞—Ç—å 3 –∏–ª–∏ 5 –≤–∏–¥–µ–æ
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –≤–∏–¥–µ–æ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫—Ä–µ–¥–∏—Ç—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –≤–∏–¥–µ–æ –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏

### Test Case 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ KIE
1. **USER_ERROR** - –∑–∞–ø—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
   - –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –∫—Ä–µ–¥–∏—Ç
   - –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª
   
2. **TEMPORARY** - 500 internal error
   - –î–æ–ª–∂–µ–Ω —Å–¥–µ–ª–∞—Ç—å retry (–¥–æ 3 —Ä–∞–∑)
   - –£–≤–µ–¥–æ–º–∏—Ç—å "–ø–æ–≤—Ç–æ—Ä—è—é –ø–æ–ø—ã—Ç–∫—É"
   - –ü–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫ - –≤–µ—Ä–Ω—É—Ç—å –∫—Ä–µ–¥–∏—Ç

3. **RATE_LIMIT** - 429 Too Many Requests
   - –î–æ–ª–∂–µ–Ω –ø–æ–º–µ—Ç–∏—Ç—å –∫–ª—é—á –∫–∞–∫ rate_limited
   - Retry —á–µ—Ä–µ–∑ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É

4. **BILLING** - –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–ø–ª–∞—Ç–æ–π KIE
   - –£–≤–µ–¥–æ–º–∏—Ç—å –æ–± –æ–±—Ä–∞—â–µ–Ω–∏–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É
   - –í–µ—Ä–Ω—É—Ç—å –∫—Ä–µ–¥–∏—Ç

### Test Case 4: –ö–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
1. –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∏–¥–µ–æ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–Ω–æ–ø–∫–∏:
   - üîÑ "–°–¥–µ–ª–∞—Ç—å –µ—â—ë —Å —ç—Ç–∏–º —Ç–æ–≤–∞—Ä–æ–º"
   - üè† "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é"

2. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–°–¥–µ–ª–∞—Ç—å –µ—â—ë":
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ job
   - –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –≤—ã–±–æ—Ä—É —à–∞–±–ª–æ–Ω–∞

---

## üîß –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

### Retry Mechanism
```python
# –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ (–°–õ–û–ú–ê–ù–ê):
for retry_attempt in range(MAX_RETRY_ATTEMPTS):
    # —Å–æ–∑–¥–∞—Ç—å task
    # poll
    if error and should_retry:
        break  # ??? –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ retry loop???
    continue  # ??? –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è continue

# –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (–ü–†–ê–í–ò–õ–¨–ù–ê–Ø):
while not shutdown_flag:
    job = await fetch_next_queued_job()
    
    # create task & poll
    
    if error and should_retry:
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º job –≤ queued status
        await update_job(job_id, {"status": "queued", "attempts": attempts})
        await asyncio.sleep(retry_delay)
        continue  # –±–µ—Ä–µ–º —Å–ª–µ–¥—É—é—â–∏–π job (–º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ—Ç –∂–µ)
    
    # success –∏–ª–∏ final fail
```

### Notification Flow
```
–°—Ç–∞—Ä—ã–π flow:
1. User –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å"
2. generation.py: —Å–æ–∑–¥–∞–µ—Ç job + ‚ùå –û–¢–ü–†–ê–í–õ–Ø–ï–¢ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
3. worker.py: –±–µ—Ä–µ—Ç job + ‚ùå –°–ù–û–í–ê –û–¢–ü–†–ê–í–õ–Ø–ï–¢ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
= 2 –¥—É–±–ª—è!

–ù–æ–≤—ã–π flow:
1. User –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å"  
2. generation.py: —Å–æ–∑–¥–∞–µ—Ç job (–ë–ï–ó —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
3. worker.py: –±–µ—Ä–µ—Ç job + –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –û–î–ù–û —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
= ‚úÖ –ß–∏—Å—Ç–æ!
```

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ (CRITICAL):
1. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ Telegram
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ KIE API (—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∏)
3. ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤—Å–µ error scenarios
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫—É "–°–¥–µ–ª–∞—Ç—å –µ—â—ë"

### –°–∫–æ—Ä–æ (HIGH):
1. –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –≤—ã–±–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ (1/3/5) - **–£–ñ–ï –î–û–ë–ê–í–õ–ï–ù–û –≤ –∫–æ–¥–µ**
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã
4. –î–æ–±–∞–≤–∏—Ç—å metrics (Prometheus/Grafana)

### –ü–æ—Ç–æ–º (MEDIUM):
1. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API KIE
2. Rate limits –∏ –∫–≤–æ—Ç—ã
3. –†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞, –Ω—É–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å)
4. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ worker'–æ–≤ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫—É

---

## üìä CHECKLIST –ì–û–¢–û–í–ù–û–°–¢–ò –ö PRODUCTION

### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- [x] –°–æ–∑–¥–∞–Ω–∏–µ job –∏ —Å–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤ (–∞—Ç–æ–º–∞—Ä–Ω–æ)
- [x] –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –≤ storage
- [x] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–¥–∞—á–∏ –≤ KIE API
- [x] Polling —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—Ö–∞ (–æ—Ç–ø—Ä–∞–≤–∫–∞ –≤–∏–¥–µ–æ)
- [x] –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫ KIE
- [x] Retry mechanism –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
- [x] –í–æ–∑–≤—Ä–∞—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- [x] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ –¥—É–±–ª–µ–π)
- [ ] **NEEDS TESTING:** –†–µ–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ KIE API
- [ ] **NEEDS TESTING:** –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ
- [ ] **NEEDS TESTING:** –ö–Ω–æ–ø–∫–∞ "–°–¥–µ–ª–∞—Ç—å –µ—â—ë"

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- [x] 5 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö worker'–æ–≤
- [x] PostgreSQL connection pooling
- [x] Graceful shutdown
- [x] Error recovery —Å retry
- [ ] Horizontal scaling (–≥–æ—Ç–æ–≤–æ, –Ω–æ –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π)
- [ ] Monitoring & Alerting

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- [x] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)
- [x] –ù–µ—Ç Supabase –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- [x] API keys –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [x] Idempotency keys –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–µ–π
- [ ] Rate limiting (–µ—Å—Ç—å –≤ KIE rotator, –Ω—É–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å)

---

## üí° –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

1. **–î—É–±–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ò–°–ü–†–ê–í–õ–ï–ù–´** - —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ worker –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
2. **Retry logic –ü–ï–†–ï–ü–ò–°–ê–ù–ê** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
3. **Worker pool —Ä–∞–±–æ—Ç–∞–µ—Ç** - 5 worker'–æ–≤ –≥–æ—Ç–æ–≤—ã –∫ –Ω–∞–≥—Ä—É–∑–∫–µ
4. **–ö–ò–ï API –∫–ª—é—á —Ä–∞–±–æ—á–∏–π** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª dcf5ae0bd4cf7736f0dbcd5337c0d9fd
5. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL** - Supabase –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–±—Ä–∞–Ω

---

## üêõ –ò–ó–í–ï–°–¢–ù–´–ï ISSUE (—Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

1. **–ù–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ä–µ–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ KIE**
   - –ù—É–∂–µ–Ω —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å —Ñ–æ—Ç–æ + –ø—Ä–æ–º–ø—Ç–æ–º
   - –ù—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ API –æ—Ç–≤–µ—á–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –ù—É–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫

2. **–ö–Ω–æ–ø–∫–∞ "–°–¥–µ–ª–∞—Ç—å –µ—â—ë —Å —ç—Ç–∏–º —Ç–æ–≤–∞—Ä–æ–º" –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞**
   - –ö–æ–¥ –µ—Å—Ç—å –≤ menu_and_flow.py (—Å—Ç—Ä–æ–∫–∏ 369-412)
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç callback_data `retry:{job_id}`
   - –ù—É–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î

3. **–í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–æ –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω**
   - Keyboard kb_video_count() —Å–æ–∑–¥–∞–Ω–∞
   - Handler on_video_count() –¥–æ–±–∞–≤–ª–µ–Ω
   - Loop –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è N jobs –µ—Å—Ç—å
   - –ù—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ N –≤–∏–¥–µ–æ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è

---

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é! –ñ–¥—É —Ñ–∏–¥–±–µ–∫–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.**

