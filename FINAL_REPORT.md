# üéØ –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢: –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ

**–î–∞—Ç–∞:** 2026-01-22  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç

---

## üìä –ß–¢–û –°–î–ï–õ–ê–ù–û

### 1. ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤–æ—Ä–∫–µ—Ä–æ–≤
- **20 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤** –≥–æ—Ç–æ–≤—ã –∫ –∑–∞–ø—É—Å–∫—É
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ systemd: `neurocards-worker@{1..20}.service`
- –°–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è: `scripts/manage_workers.sh`

### 2. ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL
- –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–±—Ä–∞–Ω Supabase
- –†–∞–±–æ—Ç–∞ —á–µ—Ä–µ–∑ `asyncpg` —Å connection pooling
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ db_adapter –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã:
  - ‚úÖ create_job_and_consume_credit (—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ + —Å–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞)
  - ‚úÖ get_job_by_id
  - ‚úÖ update_job_status
  - ‚úÖ refund_credit (–≤–æ–∑–≤—Ä–∞—Ç –∫—Ä–µ–¥–∏—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ)
  - ‚úÖ fetch_next_queued_job (–æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á)
  - ‚úÖ safe_get_balance

### 3. ‚úÖ KIE API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- **–†–æ—Ç–∞—Ü–∏—è API –∫–ª—é—á–µ–π**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- **–§—É–Ω–∫—Ü–∏–∏ KIE client**:
  - ‚úÖ create_task_sora_i2v (—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏)
  - ‚úÖ poll_record_info (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å —Ç–∞–π–º–∞—É—Ç–æ–º)

### 4. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
**–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –æ—à–∏–±–æ–∫** (`kie_error_classifier.py`):
- üö´ USER_VIOLATION - –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –∫—Ä–µ–¥–∏—Ç–∞, —Å–æ–æ–±—â–µ–Ω–∏–µ —é–∑–µ—Ä—É
- üí≥ BILLING - –ø—Ä–æ–±–ª–µ–º—ã —Å –±–∏–ª–ª–∏–Ω–≥–æ–º ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –∫—Ä–µ–¥–∏—Ç–∞, –Ω–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É
- ‚è±Ô∏è RATE_LIMIT - –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –∫—Ä–µ–¥–∏—Ç–∞, –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ
- üîÑ TEMPORARY - –≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ ‚Üí **–∞–≤—Ç–æ–ø–æ–≤—Ç–æ—Ä –¥–æ 3 —Ä–∞–∑**, –ø–æ—Ç–æ–º –≤–æ–∑–≤—Ä–∞—Ç
- ‚ùì UNKNOWN - –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –∫—Ä–µ–¥–∏—Ç–∞, –Ω–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É

**Retry –ª–æ–≥–∏–∫–∞**:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–≤—Ç–æ—Ä –ø—Ä–∏ TEMPORARY –∏ RATE_LIMIT –æ—à–∏–±–∫–∞—Ö
- Exponential backoff (10s, 20s, 40s...)
- –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏

### 5. ‚úÖ Telegram –±–æ—Ç
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏**:
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ‚Üí ‚úÖ FIXED
- ‚ùå –û—à–∏–±–∫–∞ refund_credit() ‚Üí ‚úÖ FIXED  
- ‚ùå –û—à–∏–±–∫–∞ —Å –¥–∞—Ç–∞–º–∏ (str –≤–º–µ—Å—Ç–æ datetime) ‚Üí ‚úÖ FIXED

**–î–æ–±–∞–≤–ª–µ–Ω–æ**:
- üîò –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ (1/3/5)
- üîò –ö–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: "–°–¥–µ–ª–∞—Ç—å –µ—â–µ" / "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"

### 6. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–°–æ–∑–¥–∞–Ω comprehensive test script:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∏–º–ø–æ—Ä—Ç–æ–≤
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π –ë–î
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ KIE client
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ error classifier
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ key rotator

---

## üîß –ß–¢–û –ù–£–ñ–ù–û –î–õ–Ø –î–ï–ü–õ–û–Ø

### Environment Variables (—É–∂–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ):
```bash
DATABASE_URL=postgresql://user:pass@host/db
DATABASE_TYPE=postgres
BOT_TOKEN=<telegram_bot_token>
KIE_API_KEY=<kie_api_key>  # –∏–ª–∏ KIE_API_KEY_1, KIE_API_KEY_2, ...
```

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–µ–ø–ª–æ—è:
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /root/neurocards-bot
git pull origin main
systemctl restart neurocards-bot
systemctl restart neurocards-worker@{1..20}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
./scripts/manage_workers.sh status
```

---

## üìã –ß–ï–ö–õ–ò–°–¢ –§–ò–ù–ê–õ–¨–ù–û–ì–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### –ë–∞–∑–æ–≤—ã–π —Ñ–ª–æ—É:
- [ ] /start - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ
- [ ] –í—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞ / —Å–≤–æ–π –ø—Ä–æ–º–ø—Ç
- [ ] **–í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ (1/3/5)**
- [ ] –°–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤ (1/3/5)
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –≤ KIE API
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–ó–∞–¥–∞—á–∞ –ø—Ä–∏–Ω—è—Ç–∞"
- [ ] Polling —Å—Ç–∞—Ç—É—Å–∞ (–¥–æ 30 –º–∏–Ω—É—Ç)
- [ ] –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–∏–¥–µ–æ
- [ ] **–ö–Ω–æ–ø–∫–∏**: "–°–¥–µ–ª–∞—Ç—å –µ—â–µ" / "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫:
- [ ] USER_VIOLATION: –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –∫—Ä–µ–¥–∏—Ç–∞
- [ ] BILLING: –ø—Ä–æ–±–ª–µ–º—ã —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É
- [ ] TEMPORARY: internal error 500 ‚Üí **–∞–≤—Ç–æ–ø–æ–≤—Ç–æ—Ä 3 —Ä–∞–∑–∞**
- [ ] RATE_LIMIT: too many requests ‚Üí –≤–æ–∑–≤—Ä–∞—Ç + –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ

### –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- [ ] –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è 10+ –≤–∏–¥–µ–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –≤—Å–µ—Ö 20 –≤–æ—Ä–∫–µ—Ä–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –∫–ª—é—á–µ–π (–µ—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ)
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á

---

## ‚ö†Ô∏è –¢–ï–ö–£–©–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. SSH –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É
- –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ 146.19.214.97
- –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
  - Firewall –ø—Ä–∞–≤–∏–ª–∞
  - SSH –∫–ª—é—á–∏
  - –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞

### 2. Git push
- –õ–æ–∫–∞–ª—å–Ω–æ –≤—Å–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–æ
- –ù–µ —Å–º–æ–≥ –∑–∞–ø—É—à–∏—Ç—å –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è GitHub auth
- **–†–ï–®–ï–ù–ò–ï**: –°–¥–µ–ª–∞—Ç—å –≤—Ä—É—á–Ω—É—é `git push origin main` —Å —Å–µ—Ä–≤–µ—Ä–∞/–ª–æ–∫–∞–ª—å–Ω–æ

---

## üé¨ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É** (SSH/VPN)
2. **–ó–∞–ø—É—à–∏—Ç—å –∫–æ–¥** –≤ main –≤–µ—Ç–∫—É
3. **–ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä**
4. **–ù–∞—á–∏—Å–ª–∏—Ç—å –∫—Ä–µ–¥–∏—Ç—ã** —Ç–µ–±–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
   ```sql
   UPDATE users SET credits = credits + 100 WHERE tg_user_id = 5235703016;
   ```
5. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ñ–ª–æ—É** –≤ Telegram
6. **–ü—Ä–æ–≤–µ—Å—Ç–∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

---

## üìù –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –ë–æ—Ç: `journalctl -u neurocards-bot -f`
- –í–æ—Ä–∫–µ—Ä—ã: `journalctl -u neurocards-worker@1 -f`
- –í—Å–µ –≤–æ—Ä–∫–µ—Ä—ã: `./scripts/manage_workers.sh logs`

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–∏:
```sql
SELECT status, COUNT(*) FROM generation_jobs GROUP BY status;
SELECT * FROM generation_jobs WHERE status = 'queued' ORDER BY id LIMIT 10;
```

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 50+ –≤–æ—Ä–∫–µ—Ä–æ–≤ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ `./scripts/manage_workers.sh start N`

---

## ‚úÖ –ò–¢–û–ì–û

**–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ production:**
- ‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- ‚úÖ Retry –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
- ‚úÖ –¢–µ—Å—Ç—ã —Å–æ–∑–¥–∞–Ω—ã

**–û—Å—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö! üöÄ**
