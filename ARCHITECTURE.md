# Neurocards Bot - ะััะธัะตะบัััะฐ ะธ Deployment

## ๐๏ธ ะััะธัะตะบัััะฐ

ะกะธััะตะผะฐ ัะฐะทะดะตะปะตะฝะฐ ะฝะฐ **3 ะฝะตะทะฐะฒะธัะธะผัั ะบะพะผะฟะพะฝะตะฝัะฐ**:

```
โโโโโโโโโโโโโโโโโโโ
โ   Telegram      โ
โ   Users         โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Bot Service (Webhook/Polling)     โ  โ ะะตะฑ-ัะตัะฒะธั, ะฟัะธะฝะธะผะฐะตั ะทะฐะฟัะพัั
โ   - ะัะธะฝะธะผะฐะตั ัะพัะพ                  โ
โ   - ะกะพะฑะธัะฐะตั ะฟะฐัะฐะผะตััั              โ
โ   - ะกะพะทะดะฐะตั job ะฒ ะะ (status=queued)โ
โ   - ะะ ะะะะะะข ะณะตะฝะตัะฐัะธั             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   PostgreSQL Database               โ  โ ะัะตัะตะดั ะทะฐะดะฐะฝะธะน
โ   - jobs (queued/processing/done)   โ
โ   - users, credits                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Workers (1-20 ะธะฝััะฐะฝัะพะฒ)          โ  โ ะคะพะฝะพะฒัะต ะฟัะพัะตััั
โ   - ะะฐะฑะธัะฐัั jobs ะธะท ะะ             โ
โ   - ะัะทัะฒะฐัั GPT โ KIE AI           โ
โ   - ะะพะทะฒัะฐัะฐัั ัะตะทัะปััะฐั ัะทะตัั      โ
โ   - ะะฑัะฐะฑะฐััะฒะฐัั ะพัะธะฑะบะธ + retry     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## โ ะัะตะธะผััะตััะฒะฐ ัะฐะบะพะน ะฐััะธัะตะบัััั

1. **ะะตั ะบะพะฝัะปะธะบัะพะฒ** - ะฑะพั ะธ ะฒะพัะบะตัั ะฝะต ะผะตัะฐัั ะดััะณ ะดััะณั
2. **ะะฐัััะฐะฑะธััะตะผะพััั** - ะผะพะถะฝะพ ะทะฐะฟัััะธัั 1-20 ะฒะพัะบะตัะพะฒ ะฟะฐัะฐะปะปะตะปัะฝะพ
3. **ะะฐะดะตะถะฝะพััั** - ะตัะปะธ ะฒะพัะบะตั ัะฟะฐะป, ะฑะพั ะฟัะพะดะพะปะถะฐะตั ัะฐะฑะพัะฐัั
4. **ะกะบะพัะพััั ะพัะฒะตัะฐ ะฑะพัะฐ** - 100-200ms (ะฝะต ะถะดะตั ะณะตะฝะตัะฐัะธั)
5. **ะะฑัะฐะฑะพัะบะฐ ะฟะธะบะพะฒัั ะฝะฐะณััะทะพะบ** - ะพัะตัะตะดั ะฒ ะะ + N ะฒะพัะบะตัะพะฒ

## ๐ฆ Deployment Options

### Option 1: Docker Compose (ะะตะบะพะผะตะฝะดัะตััั)

```bash
# 1. ะกะพะทะดะฐะนัะต .env ัะฐะนะป
cp .env.example .env
nano .env

# 2. ะะฐะฟัััะธัะต ะฒัะต ัะตัะฒะธัั
docker-compose up -d

# 3. ะัะพะฒะตัััะต ััะฐััั
docker-compose ps
docker-compose logs -f bot
docker-compose logs -f worker

# 4. ะะฐัััะฐะฑะธัะพะฒะฐะฝะธะต ะฒะพัะบะตัะพะฒ
docker-compose up -d --scale worker=10
```

### Option 2: VPS ั systemd

```bash
# 1. ะะปะพะฝะธััะนัะต ัะตะฟะพะทะธัะพัะธะน
git clone <repo> /var/neurocards/neurocards-bot
cd /var/neurocards/neurocards-bot

# 2. ะกะพะทะดะฐะนัะต .env
cp .env.example .env
nano .env

# 3. ะฃััะฐะฝะพะฒะธัะต ะทะฐะฒะธัะธะผะพััะธ
pip3 install -r requirements.txt

# 4. ะะฐัััะพะนัะต PostgreSQL
sudo -u postgres createdb neurocards
sudo -u postgres createuser neurocards_user
python3 scripts/migrate_db.py

# 5. ะะตะฟะปะพะน ัะตัะตะท ัะบัะธะฟั
./deploy_vps.sh

# ะกะบัะธะฟั ะฐะฒัะพะผะฐัะธัะตัะบะธ:
# - ะััะฐะฝะฐะฒะปะธะฒะฐะตั ััะฐััะต ัะตัะฒะธัั
# - ะะฑะฝะพะฒะปัะตั ะบะพะด
# - ะะฐะฟััะบะฐะตั ะฑะพัะฐ (webhook)
# - ะะฐะฟััะบะฐะตั 5 ะฒะพัะบะตัะพะฒ (ะฟะพ ัะผะพะปัะฐะฝะธั)
```

## ๐ง ะฃะฟัะฐะฒะปะตะฝะธะต ัะตัะฒะธัะฐะผะธ

```bash
# ะัะพัะผะพัั ะปะพะณะพะฒ
sudo journalctl -u neurocards-bot-webhook.service -f
sudo journalctl -u neurocards-worker@1.service -f

# ะััะฐะฝะพะฒะธัั ะฒัะต
./scripts/stop_all.sh

# ะะตัะตะทะฐะฟัััะธัั ะฒัะต
./scripts/restart_all.sh

# ะะพะฑะฐะฒะธัั ะฑะพะปััะต ะฒะพัะบะตัะพะฒ
sudo systemctl start neurocards-worker@6.service
sudo systemctl start neurocards-worker@7.service

# ะัะพะฒะตัะธัั ััะฐััั
sudo systemctl status neurocards-bot-webhook.service
sudo systemctl status neurocards-worker@*.service
```

## ๐ ะะพะฝะธัะพัะธะฝะณ

### Queue Stats Endpoint

```bash
curl http://localhost:10000/queue_stats
```

ะะตัะฝะตั:
```json
{
  "status": "ok",
  "queue": {
    "queued": 15,
    "processing": 5,
    "total": 20
  },
  "avg_wait_minutes": 2.3,
  "workers_configured": 5
}
```

### ะะพะณะดะฐ ะฝัะถะฝะพ ะดะพะฑะฐะฒะธัั ะฒะพัะบะตัะพะฒ?

- `queued > 10` - ะดะพะฑะฐะฒััะต 2-3 ะฒะพัะบะตัะฐ
- `queued > 50` - ะดะพะฑะฐะฒััะต 5-10 ะฒะพัะบะตัะพะฒ
- `avg_wait_minutes > 5` - ะดะพะฑะฐะฒััะต ะฒะพัะบะตัะพะฒ

## ๐จ ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ

ะะพัะบะตัั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพะฑัะฐะฑะฐััะฒะฐัั:

1. **USER_ERROR** (ะทะฐะฟัะตัะตะฝะฝะพะต ัะพัะพ/ัะตะบัั)
   - ะะพะทะฒัะฐั ะบัะตะดะธัะฐ
   - ะฃะฒะตะดะพะผะปะตะฝะธะต ัะทะตัะฐ
   - ะกัะฐััั: `failed`

2. **BILLING** (ะฟัะพะฑะปะตะผั ั API ะบะปััะพะผ)
   - ะะพะทะฒัะฐั ะบัะตะดะธัะฐ
   - ะฃะฒะตะดะพะผะปะตะฝะธะต: "ะะฑัะฐัะธัะตัั ะฒ ัะตั.ะฟะพะดะดะตัะถะบั"
   - ะะปัั ะฟะพะผะตัะฐะตััั ะบะฐะบ ะฟัะพะฑะปะตะผะฝัะน

3. **RATE_LIMIT** (ะปะธะผะธัั KIE AI)
   - Retry ัะตัะตะท 60-120 ัะตะบ
   - ะะฒัะพะผะฐัะธัะตัะบะฐั ัะพัะฐัะธั ะบะปััะตะน
   - Max 3 ะฟะพะฟััะบะธ

4. **TEMPORARY** (500 Internal Server Error)
   - Retry ัะตัะตะท 30-60 ัะตะบ
   - Max 3 ะฟะพะฟััะบะธ
   - ะัะปะธ ะฝะต ะฟะพะผะพะณะปะพ โ ะฒะพะทะฒัะฐั ะบัะตะดะธัะฐ

## ๐ ะะพัะฐัะธั API ะบะปััะตะน

ะะพะฑะฐะฒััะต ะฝะตัะบะพะปัะบะพ ะบะปััะตะน ะฒ `.env`:

```bash
KIE_API_KEY=key1,key2,key3
```

ะะพัะฐัะพั ะฐะฒัะพะผะฐัะธัะตัะบะธ:
- ะะตัะตะบะปััะฐะตััั ะฝะฐ ะทะดะพัะพะฒัะน ะบะปัั
- ะััะปะตะถะธะฒะฐะตั rate limits
- ะะพะผะตัะฐะตั ะฟัะพะฑะปะตะผะฝัะต ะบะปััะธ

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

```bash
# ะะพะบะฐะปัะฝัะน ัะตัั ะฒะพัะบะตัะฐ
python3 -m worker.worker

# ะขะตัั ะฒัะตะน ัะธััะตะผั
python3 tests/test_full_flow.py

# ะะฐะณััะทะพัะฝัะน ัะตัั
python3 tests/stress_test.py --jobs=100 --workers=10
```

## ๐ ะะฐัััะฐะฑะธัะพะฒะฐะฝะธะต ะฟะพะด 1.2ะ ะฟะพะปัะทะพะฒะฐัะตะปะตะน

### ะะฐััะตั ะฒะพัะบะตัะพะฒ

- 1 ะฒะธะดะตะพ = ~5 ะผะธะฝัั ะณะตะฝะตัะฐัะธะธ
- 1 ะฒะพัะบะตั = 12 ะฒะธะดะตะพ/ัะฐั
- 1000 ะทะฐะฟัะพัะพะฒ ะฒ ะฟะธะบ (8-10 ะฒะตัะตัะฐ) = ~2 ัะฐัะฐ ะฟะธะบ

**ะะธะฝะธะผัะผ:** 10 ะฒะพัะบะตัะพะฒ (120 ะฒะธะดะตะพ/ัะฐั)
**ะะตะบะพะผะตะฝะดะพะฒะฐะฝะพ:** 20 ะฒะพัะบะตัะพะฒ (240 ะฒะธะดะตะพ/ัะฐั)
**ะัะธ 1ะ+ ะฐะบัะธะฒะฝะพััะธ:** 50+ ะฒะพัะบะตัะพะฒ

### ะะฐัััะพะนะบะฐ ะดะปั ะฒััะพะบะพะน ะฝะฐะณััะทะบะธ

```yaml
# docker-compose.yml
services:
  worker:
    deploy:
      replicas: 20  # 20 ะฟะฐัะฐะปะปะตะปัะฝัั ะฒะพัะบะตัะพะฒ

  postgres:
    command: >
      -c max_connections=200
      -c shared_buffers=2GB
      -c effective_cache_size=6GB
```

## ๐ ะะตะทะพะฟะฐัะฝะพััั

- API ะบะปััะธ ัะพะปัะบะพ ะฒ `.env` (ะฝะต ะบะพะผะผะธัะธัั!)
- PostgreSQL ะฟะฐัะพะปะธ ัะตัะตะท ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
- Webhook secret token ะดะปั ะทะฐัะธัั ะพั ัะฟะฐะผะฐ
- Rate limiting ะฝะฐ ััะพะฒะฝะต ะฑะพัะฐ

## ๐ ะะพะดะดะตัะถะบะฐ

- ะัะธะฑะบะธ ะฑะพัะฐ: ะฟัะพะฒะตัััะต `bot.log`
- ะัะธะฑะบะธ ะฒะพัะบะตัะฐ: ะฟัะพะฒะตัััะต `worker-1.log`
- ะัะพะฑะปะตะผั ั ะะ: `sudo journalctl -u postgresql.service`
- ะะฑัะธะต ะฒะพะฟัะพัั: @kirbudilov

